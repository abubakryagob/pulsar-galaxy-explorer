<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Simple Pulsar Visualization</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background-color: #000000;
      color: white;
      font-family: 'Courier New', monospace;
    }

    canvas {
      display: block;
      width: 100%;
      height: 100%;
    }

    #info {
      position: absolute;
      top: 15px;
      width: 100%;
      text-align: center;
      z-index: 100;
      pointer-events: none;
    }

    #status {
      font-size: 14px;
      padding: 10px 18px;
      background-color: rgba(25, 30, 50, 0.35);
      border-radius: 10px;
      display: inline-block;
      text-shadow: 0 0 5px rgba(0, 128, 255, 0.8);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    #error-display {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background-color: rgba(255, 0, 0, 0.7);
      color: white;
      padding: 10px;
      z-index: 10000;
      font-family: monospace;
      font-size: 14px;
      max-height: 50%;
      overflow: auto;
      display: none;
    }
  </style>
</head>
<body>
  <div id="error-display"></div>
  <div id="info">
    <div id="status">Loading Three.js...</div>
  </div>
  <canvas id="webglCanvas"></canvas>

  <!-- Direct script loading (no importmap) -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.163.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.163.0/examples/js/controls/OrbitControls.js"></script>

  <script>
    // Error handler
    window.addEventListener('error', function(e) {
      const errorDisplay = document.getElementById('error-display');
      errorDisplay.style.display = 'block';
      errorDisplay.textContent += `ERROR: ${e.message} at ${e.lineno}\n`;
      console.error(e);
    });

    // Wait for Three.js to load
    window.addEventListener('DOMContentLoaded', () => {
      // Check if Three.js is available
      if (!window.THREE) {
        document.getElementById('error-display').style.display = 'block';
        document.getElementById('error-display').textContent = 'Three.js failed to load!';
        return;
      }

      document.getElementById('status').textContent = 'Initializing Visualization...';

      try {
        // Sample pulsar data - small subset for testing
        const pulsarData = [
          {
            "name": "J0437-4715",
            "association": "mw",
            "period": 0.00575745,
            "gl": 253.39,
            "gb": -41.96,
            "distance": 0.156
          },
          {
            "name": "Vela Pulsar",
            "association": "Vela",
            "period": 0.0892199,
            "gl": 263.55,
            "gb": -2.79,
            "distance": 0.28
          },
          {
            "name": "Crab Pulsar",
            "association": "Crab",
            "period": 0.0331,
            "gl": 184.56,
            "gb": -5.78,
            "distance": 2
          }
        ];

        // Basic Three.js setup
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x000000);
        
        // Camera setup
        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 5, 10);
        
        // Renderer setup
        const renderer = new THREE.WebGLRenderer({
          canvas: document.getElementById('webglCanvas'),
          antialias: true
        });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        
        // OrbitControls
        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        
        // Add ambient light
        const ambientLight = new THREE.AmbientLight(0x404040);
        scene.add(ambientLight);
        
        // Create a simple galaxy - just some random stars
        const starGeometry = new THREE.BufferGeometry();
        const starCount = 1000;
        const starPositions = new Float32Array(starCount * 3);
        
        for (let i = 0; i < starCount * 3; i += 3) {
          // Random distribution in a disc shape
          const radius = 5 + Math.random() * 15;
          const angle = Math.random() * Math.PI * 2;
          
          starPositions[i] = Math.cos(angle) * radius;     // x
          starPositions[i + 1] = (Math.random() - 0.5) * 3; // y
          starPositions[i + 2] = Math.sin(angle) * radius; // z
        }
        
        starGeometry.setAttribute('position', new THREE.BufferAttribute(starPositions, 3));
        
        const starMaterial = new THREE.PointsMaterial({
          color: 0xFFFFFF,
          size: 0.1
        });
        
        const starfield = new THREE.Points(starGeometry, starMaterial);
        scene.add(starfield);
        
        // Create pulsars
        pulsarData.forEach(pulsar => {
          // Create pulsar mesh
          const pulsarGeometry = new THREE.SphereGeometry(0.2, 8, 8);
          
          // Color based on period
          let color;
          if (pulsar.period < 0.01) {
            color = 0x00a2ff; // blue for fast pulsars
          } else if (pulsar.period < 0.1) {
            color = 0x00ffea; // cyan for medium pulsars
          } else {
            color = 0xc080ff; // purple for slow pulsars
          }
          
          const pulsarMaterial = new THREE.MeshBasicMaterial({ color: color });
          const pulsarMesh = new THREE.Mesh(pulsarGeometry, pulsarMaterial);
          
          // Position using galactic coordinates (simplified)
          const dist = pulsar.distance || 5;
          const lon = pulsar.gl * (Math.PI / 180);
          const lat = pulsar.gb * (Math.PI / 180);
          
          pulsarMesh.position.x = dist * Math.cos(lat) * Math.cos(lon);
          pulsarMesh.position.y = dist * Math.sin(lat);
          pulsarMesh.position.z = dist * Math.cos(lat) * Math.sin(lon);
          
          scene.add(pulsarMesh);
          
          // Add simple pulse animation
          const pulseSpeed = 1 / pulsar.period; // faster period = faster pulse
          const pulseData = {
            mesh: pulsarMesh,
            speed: Math.min(2, pulseSpeed), // cap the speed
            time: Math.random() * 100 // random starting phase
          };
          
          pulsars.push(pulseData);
        });
        
        // Update status
        document.getElementById('status').textContent = 'Pulsar Visualization';
        
        // Animation variables
        const pulsars = [];
        const clock = new THREE.Clock();
        
        // Animation loop
        function animate() {
          requestAnimationFrame(animate);
          
          const delta = clock.getDelta();
          
          // Update pulsar animations
          pulsars.forEach(pulsar => {
            pulsar.time += delta * pulsar.speed;
            const scale = 1 + 0.2 * Math.sin(pulsar.time * 5);
            pulsar.mesh.scale.set(scale, scale, scale);
          });
          
          // Update controls
          controls.update();
          
          // Render
          renderer.render(scene, camera);
        }
        
        // Start animation loop
        animate();
        
        // Handle window resize
        window.addEventListener('resize', () => {
          camera.aspect = window.innerWidth / window.innerHeight;
          camera.updateProjectionMatrix();
          renderer.setSize(window.innerWidth, window.innerHeight);
        });
        
      } catch (error) {
        console.error("Error in initialization:", error);
        document.getElementById('error-display').style.display = 'block';
        document.getElementById('error-display').textContent = `Error in initialization: ${error.message}`;
        document.getElementById('status').textContent = 'Error Loading';
      }
    });
  </script>
</body>
</html>
