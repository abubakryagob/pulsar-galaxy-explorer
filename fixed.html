<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fixed Pulsar Galaxy Explorer</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background-color: #000000;
      color: white;
      font-family: 'Courier New', monospace;
    }

    canvas {
      display: block;
      width: 100%;
      height: 100%;
    }

    #ui {
      position: absolute;
      top: 15px;
      width: 100%;
      text-align: center;
      z-index: 100;
      pointer-events: none;
    }

    #info {
      font-size: 14px;
      padding: 10px 18px;
      background-color: rgba(25, 30, 50, 0.35);
      border-radius: 10px;
      display: inline-block;
      text-shadow: 0 0 5px rgba(0, 128, 255, 0.8);
      border: 1px solid rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      transition: all 0.3s ease;
      box-shadow: inset 0 0 10px rgba(255, 255, 255, 0.05);
    }

    #loading {
      position: fixed;
      width: 100%;
      height: 100%;
      background: #000;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      transition: opacity 0.6s ease-out;
    }

    #loading span {
      font-size: 24px;
      letter-spacing: 2px;
      margin-bottom: 15px;
    }

    #progress-container {
      width: 60%;
      max-width: 300px;
      height: 6px;
      background-color: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
      overflow: hidden;
    }

    #progress {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #00a2ff, #00ffea);
      transition: width 0.3s ease;
      border-radius: 3px;
    }

    #controls {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 100;
      text-align: center;
      background-color: rgba(25, 30, 50, 0.4);
      padding: 15px 25px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    button {
      background: rgba(0, 80, 180, 0.7);
      color: white;
      border: 1px solid rgba(0, 180, 255, 0.6);
      border-radius: 6px;
      padding: 8px 15px;
      margin: 0 8px;
      cursor: pointer;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      transition: all 0.25s ease;
    }

    button:hover {
      background: rgba(0, 110, 220, 0.9);
      border-color: rgba(0, 210, 255, 0.9);
      transform: translateY(-1px);
      box-shadow: 0 3px 8px rgba(0, 150, 255, 0.3);
    }

    #error-display {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background-color: rgba(255, 0, 0, 0.7);
      color: white;
      padding: 10px;
      z-index: 10000;
      font-family: monospace;
      font-size: 14px;
      max-height: 50%;
      overflow: auto;
      display: none;
    }
  </style>
</head>
<body>
  <div id="error-display"></div>
  
  <div id="loading">
    <span>Loading Pulsar Data...</span>
    <div id="progress-container">
      <div id="progress"></div>
    </div>
  </div>

  <div id="ui">
    <div id="info">Pulsar Galaxy Explorer</div>
  </div>

  <div id="controls">
    <button id="view-all-btn">View All</button>
    <button id="fast-pulsars-btn">Fast Pulsars</button>
    <button id="slow-pulsars-btn">Slow Pulsars</button>
  </div>

  <canvas id="webglCanvas"></canvas>

  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.163.0/build/three.module.js",
      "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.163.0/examples/jsm/"
    }
  }
  </script>

  <script type="module">
    // Sample pulsar data - small subset for testing
    const pulsarData = [
      {
        "JNAME": "J0437-4715",
        "ASSOC": "mw",
        "P0": 0.00575745,
        "GL": 253.39,
        "GB": -41.96,
        "DIST": 0.156
      },
      {
        "JNAME": "B0833-45",
        "ASSOC": "Vela",
        "P0": 0.0892199,
        "GL": 263.55,
        "GB": -2.79,
        "DIST": 0.28
      },
      {
        "JNAME": "B0531+21",
        "ASSOC": "Crab",
        "P0": 0.0331,
        "GL": 184.56,
        "GB": -5.78,
        "DIST": 2
      },
      {
        "JNAME": "J1814-1649",
        "ASSOC": "",
        "P0": 13.82,
        "GL": 13.82,
        "GB": 1,
        "DIST": 7.56
      },
      {
        "JNAME": "J1801-0857",
        "ASSOC": "GC:NGC6517",
        "P0": 0.177,
        "GL": 19.23,
        "GB": 0.01,
        "DIST": 9.3
      }
    ];

    // Error handling
    window.addEventListener('error', function(e) {
      const errorDisplay = document.getElementById('error-display');
      errorDisplay.style.display = 'block';
      errorDisplay.textContent += `ERROR: ${e.message} at ${e.filename}:${e.lineno}\n`;
      console.error(e);
    });

    // Import Three.js modules
    try {
      import('three').then(THREE => {
        import('three/addons/controls/OrbitControls.js').then(({ OrbitControls }) => {
          console.log("Three.js and OrbitControls loaded successfully");
          initVisualization(THREE, OrbitControls);
        }).catch(error => {
          console.error("Failed to load OrbitControls:", error);
          document.getElementById('error-display').style.display = 'block';
          document.getElementById('error-display').textContent = `Failed to load OrbitControls: ${error.message}`;
        });
      }).catch(error => {
        console.error("Failed to load Three.js:", error);
        document.getElementById('error-display').style.display = 'block';
        document.getElementById('error-display').textContent = `Failed to load Three.js: ${error.message}`;
      });
    } catch (error) {
      console.error("Error during module import:", error);
      document.getElementById('error-display').style.display = 'block';
      document.getElementById('error-display').textContent = `Error during module import: ${error.message}`;
    }

    // Visualization initialization
    function initVisualization(THREE, OrbitControls) {
      try {
        // Scene setup
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x000000);
        
        // Camera setup
        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 15, 30);
        
        // Renderer setup
        const renderer = new THREE.WebGLRenderer({
          canvas: document.getElementById('webglCanvas'),
          antialias: true
        });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        
        // OrbitControls
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        
        // Add ambient light
        const ambientLight = new THREE.AmbientLight(0x202020);
        scene.add(ambientLight);
        
        // Add stars (background)
        addStarfield(scene, THREE);
        
        // Add pulsars
        addPulsars(scene, THREE);
        
        // Update progress and hide loading screen
        const loadingScreen = document.getElementById('loading');
        const progressBar = document.getElementById('progress');
        progressBar.style.width = '100%';
        
        setTimeout(() => {
          loadingScreen.style.opacity = '0';
          setTimeout(() => {
            loadingScreen.style.display = 'none';
          }, 600);
        }, 500);
        
        // Animation loop
        function animate() {
          requestAnimationFrame(animate);
          controls.update();
          renderer.render(scene, camera);
        }
        
        // Start animation loop
        animate();
        
        // Handle window resize
        window.addEventListener('resize', () => {
          camera.aspect = window.innerWidth / window.innerHeight;
          camera.updateProjectionMatrix();
          renderer.setSize(window.innerWidth, window.innerHeight);
        });
        
        // Button event listeners
        document.getElementById('view-all-btn').addEventListener('click', () => {
          console.log("View all pulsars");
        });
        
        document.getElementById('fast-pulsars-btn').addEventListener('click', () => {
          console.log("View fast pulsars");
        });
        
        document.getElementById('slow-pulsars-btn').addEventListener('click', () => {
          console.log("View slow pulsars");
        });
        
      } catch (error) {
        console.error("Error in initialization:", error);
        document.getElementById('error-display').style.display = 'block';
        document.getElementById('error-display').textContent = `Error in initialization: ${error.message}`;
      }
    }
    
    // Create starfield background
    function addStarfield(scene, THREE) {
      const starGeometry = new THREE.BufferGeometry();
      const starCount = 2000;
      
      const positions = new Float32Array(starCount * 3);
      const colors = new Float32Array(starCount * 3);
      
      const galaxyRadius = 50;
      
      for (let i = 0; i < starCount; i++) {
        // Random position in a disc-like galaxy shape
        const theta = Math.random() * Math.PI * 2;
        const r = Math.random() * galaxyRadius;
        
        const x = r * Math.cos(theta);
        const y = (Math.random() - 0.5) * 5; // Thin disc
        const z = r * Math.sin(theta);
        
        positions[i * 3] = x;
        positions[i * 3 + 1] = y;
        positions[i * 3 + 2] = z;
        
        // Color (bluish white)
        colors[i * 3] = 0.8 + Math.random() * 0.2;     // R
        colors[i * 3 + 1] = 0.8 + Math.random() * 0.2; // G
        colors[i * 3 + 2] = 1.0;                       // B
      }
      
      starGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
      starGeometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
      
      const starMaterial = new THREE.PointsMaterial({
        size: 0.15,
        vertexColors: true,
        transparent: true
      });
      
      const starfield = new THREE.Points(starGeometry, starMaterial);
      scene.add(starfield);
    }
    
    // Add pulsars to the scene
    function addPulsars(scene, THREE) {
      // Create pulsar geometry (will be instanced for performance)
      const pulsarGeometry = new THREE.SphereGeometry(1, 16, 16);
      
      // Process each pulsar from our data
      pulsarData.forEach(pulsar => {
        // Calculate position based on galactic coordinates
        // Converting from galactic coordinates to cartesian
        // GL = galactic longitude (0-360°), GB = galactic latitude (-90 to 90°)
        const r = pulsar.DIST || 10;  // Distance from Sun in kpc
        const gl = pulsar.GL * (Math.PI / 180);  // Convert to radians
        const gb = pulsar.GB * (Math.PI / 180);  // Convert to radians
        
        // Convert to Cartesian coordinates
        // Note: This is a simplified conversion that places the Sun at origin
        const x = r * Math.cos(gb) * Math.cos(gl);
        const y = r * Math.sin(gb);
        const z = r * Math.cos(gb) * Math.sin(gl);
        
        // Determine color based on period
        let color;
        const period = pulsar.P0;
        
        if (period < 0.1) {
          // Fast pulsars are blue
          color = new THREE.Color(0x00a2ff); 
        } else if (period < 1) {
          // Medium pulsars are cyan
          color = new THREE.Color(0x00ffea);
        } else {
          // Slow pulsars are white/purple
          color = new THREE.Color(0xc080ff);
        }
        
        // Calculate size based on period (smaller period = more interesting pulsars)
        const size = 0.15 + (Math.min(1, 1/Math.sqrt(period)) * 0.35);
        
        // Create pulsar material
        const pulsarMaterial = new THREE.MeshBasicMaterial({
          color: color,
          transparent: true,
          opacity: 0.8
        });
        
        // Create pulsar mesh
        const pulsarMesh = new THREE.Mesh(pulsarGeometry, pulsarMaterial);
        pulsarMesh.position.set(x, y, z);
        pulsarMesh.scale.set(size, size, size);
        
        // Store pulsar data with the mesh
        pulsarMesh.userData = pulsar;
        
        // Add to scene
        scene.add(pulsarMesh);
      });
    }
  </script>
</body>
</html>
